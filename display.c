#include <stdio.h>
#include <string.h>
#include <stdint.h>

static char *charset[] = {
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |  @  | @ @ | @ @ |  @  |@@   | @@  | @@  |   @ | @   |     |     |     |     |     |     |",
   "|     |  @  | @ @ | @ @ | @@@@|@@  @|@  @ |  @  |  @  |  @  |  @  |  @  |     |     |     |    @|",
   "|     |  @  | @ @ |@@@@@|@ @  |   @ |@ @  | @   | @   |   @ |@ @ @|  @  |     |     |     |   @ |",
   "|     |  @  |     | @ @ | @@@ |  @  | @   |     | @   |   @ | @@@ | @@@ |     |     |     |  @  |",
   "|     |     |     |@@@@@|  @ @| @   |@ @ @|     | @   |   @ |@ @ @|  @  | @@  |@@@@@|     | @   |",
   "|     |     |     | @ @ |@@@@ |@  @@|@  @ |     |  @  |  @  |  @  |  @  |  @  |     | @@  |@    |",
   "|     |  @  |     | @ @ |  @  |   @@| @@ @|     |   @ | @   |     |     | @   |     | @@  |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "| @@@ |  @  | @@@ |@@@@@|   @ |@@@@@|  @@ |@@@@@| @@@ | @@@ |     |     |   @ |     | @   | @@@ |",
   "|@   @| @@  |@   @|   @ |  @@ |@    | @   |    @|@   @|@   @| @@  | @@  |  @  |     |  @  |@   @|",
   "|@  @@|  @  |    @|  @  | @ @ |@@@@ |@    |   @ |@   @|@   @| @@  | @@  | @   |@@@@@|   @ |    @|",
   "|@ @ @|  @  |   @ |   @ |@  @ |    @|@@@@ |  @  | @@@ | @@@@|     |     |@    |     |    @|   @ |",
   "|@@  @|  @  |  @  |    @|@@@@@|    @|@   @| @   |@   @|    @| @@  | @@  | @   |@@@@@|   @ |  @  |",
   "|@   @|  @  | @   |@   @|   @ |@   @|@   @| @   |@   @|   @ | @@  |  @  |  @  |     |  @  |     |",
   "| @@@ | @@@ |@@@@@| @@@ |   @ | @@@ | @@@ | @   | @@@ | @@  |     | @   |   @ |     | @   |  @  |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "| @@@ | @@@ |@@@@ | @@@ |@@@  |@@@@@|@@@@@| @@@ |@   @| @@@ |  @@@|@   @|@    |@   @|@   @| @@@ |",
   "|    @|@   @|@   @|@   @|@  @ |@    |@    |@   @|@   @|  @  |   @ |@  @ |@    |@@ @@|@   @|@   @|",
   "|    @|@   @|@   @|@    |@   @|@    |@    |@    |@   @|  @  |   @ |@ @  |@    |@ @ @|@@  @|@   @|",
   "| @@ @|@   @|@@@@ |@    |@   @|@@@@ |@@@@ |@ @@@|@@@@@|  @  |   @ |@@   |@    |@   @|@ @ @|@   @|",
   "|@ @ @|@@@@@|@   @|@    |@   @|@    |@    |@   @|@   @|  @  |   @ |@ @  |@    |@   @|@  @@|@   @|",
   "|@ @ @|@   @|@   @|@   @|@  @ |@    |@    |@   @|@   @|  @  |@  @ |@  @ |@    |@   @|@   @|@   @|",
   "| @@@ |@   @|@@@@ | @@@ |@@@  |@@@@@|@    | @@@@|@   @| @@@ | @@  |@   @|@@@@@|@   @|@   @| @@@ |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|@@@@ | @@@ |@@@@ | @@@@|@@@@@|@   @|@   @|@   @|@   @|@   @|@@@@@| @@@ |@   @| @@@ |  @  |     |",
   "|@   @|@   @|@   @|@    |  @  |@   @|@   @|@   @|@   @|@   @|    @| @   | @ @ |   @ | @ @ |     |",
   "|@   @|@   @|@   @|@    |  @  |@   @|@   @|@   @| @ @ |@   @|   @ | @   |@@@@@|   @ |@   @|     |",
   "|@@@@ |@   @|@@@@ | @@@ |  @  |@   @|@   @|@ @ @|  @  | @ @ |  @  | @   |  @  |   @ |     |     |",
   "|@    |@ @ @|@ @  |    @|  @  |@   @|@   @|@ @ @| @ @ |  @  | @   | @   |@@@@@|   @ |     |     |",
   "|@    |@  @ |@  @ |    @|  @  |@   @| @ @ |@ @ @|@   @|  @  |@    | @   |  @  |   @ |     |     |",
   "|@    | @@ @|@   @|@@@@ |  @  | @@@ |  @  | @ @ |@   @|  @  |@@@@@| @@@ |  @  | @@@ |     |@@@@@|",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "| @   |     |@    |     |    @|     |  @@ |     |@    |  @  |    @|@    | @@  |     |     |     |",
   "|  @  |     |@    |     |    @|     | @  @|     |@    |     |     |@    |  @  | @ @ |     |     |",
   "|   @ | @@@ |@ @@ | @@@ | @@ @| @@@ | @   | @@@ |@ @@ | @@  |   @@|@  @ |  @  |@ @ @|@ @@ | @@@ |",
   "|     |    @|@@  @|@    |@  @@|@   @|@@@  |@   @|@@  @|  @  |    @|@ @  |  @  |@ @ @|@@  @|@   @|",
   "|     | @@@@|@   @|@    |@   @|@@@@@| @   |@   @|@   @|  @  |    @|@@   |  @  |@   @|@   @|@   @|",
   "|     |@   @|@   @|@   @|@   @|@    | @   |@   @|@   @|  @  |    @|@ @  |  @  |@   @|@   @|@   @|",
   "|     | @@@@|@@@@ | @@@ | @@@ | @@@ | @   | @@@@|@   @| @@@ |    @|@  @ | @@@ |@   @|@   @| @@@ |",
   "|     |     |     |     |     |     |     |    @|     |     |    @|     |     |     |     |     |",
   "|     |     |     |     |     |     |     |    @|     |     |@   @|     |     |     |     |     |",
   "|     |     |     |     |     |     |     | @@@ |     |     | @@@ |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     | @   |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     | @   |     |     |     |     |     |     |   @ |  @  |  @  |     |     |",
   "|@ @@ | @@ @|@ @@ | @@@ |@@@  |@   @|@   @|@   @|@   @|@   @|@@@@@|  @  |  @  |   @ |  @  |  @  |",
   "|@@  @|@  @@|@@  @|@    | @   |@   @|@   @|@   @| @ @ |@   @|   @ |  @  |  @  |   @ |   @ | @   |",
   "|@   @|@   @|@    | @@@ | @   |@   @|@   @|@ @ @|  @  |@   @|  @  | @   |  @  |    @|@@@@@|@@@@@|",
   "|@   @|@   @|@    |    @| @  @|@  @@| @ @ |@ @ @| @ @ |@   @| @   |  @  |  @  |   @ |   @ | @   |",
   "|@@@@ | @@@@|@    | @@@ |  @@ | @@ @|  @  | @ @ |@   @| @@@@|@@@@@|  @  |  @  |   @ |  @  |  @  |",
   "|@    |    @|     |     |     |     |     |     |     |    @|     |   @ |  @  |  @  |     |     |",
   "|@    |    @|     |     |     |     |     |     |     |@   @|     |     |     |     |     |     |",
   "|@    |    @|     |     |     |     |     |     |     | @@@ |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |  @@@|     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |  @  |     |     |     |@@@@@|     |     |     |     |     |     |     |     |     |",
   "|     |     |  @  |     |     |     |    @|@@@@@|   @ |  @  |     |   @ | @   |     |@@@@ |     |",
   "|     |     |     |     |     |@@   |@@@@@|    @|  @  |@@@@@|@@@@@|@@@@@|@@@@@|     |   @ |@ @ @|",
   "|     |@@@  |     |   @ |@    |@@   |   @ |  @@ | @@  |@   @|  @  |  @@ | @  @| @@@ |@@@@ |@ @ @|",
   "|     |@ @  |     |   @ | @   |     |  @  |  @  |@ @  |    @|  @  | @ @ | @ @ |   @ |   @ |    @|",
   "|     |@@@  |     | @@@ |  @  |     | @   | @   |  @  |  @@ |@@@@@|@  @ | @   |@@@@@|@@@@ |  @@ |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |@@@@@|     |  @  |     |   @ | @   |  @  |     | @   |     | @ @ |     |     | @   |     |",
   "|     |    @|    @|@@@@@|@@@@@|@@@@@|@@@@@|@@@@@| @@@@| @@@@|@@@@@|@@@@@|@@   |@@@@@|@@@@@|@   @|",
   "|     |  @ @|   @ |    @|  @  |   @ | @  @|  @  | @  @|@  @ |    @| @ @ |    @|    @| @  @|@   @|",
   "|@@@@ |  @@ |  @  |    @|  @  |  @@ | @  @|@@@@@|@   @|   @ |    @| @ @ |@@  @|   @ | @ @ | @  @|",
   "|     |  @  | @@  |    @|  @  | @ @ | @  @|  @  |    @|   @ |    @|   @ |    @|  @  | @   |    @|",
   "|     |  @  |@ @  |   @ |  @  |@  @ | @  @|  @  |   @ |   @ |    @|  @  |   @ | @ @ | @   |   @ |",
   "|     | @   |  @  |  @  |@@@@@|   @ |@  @ |  @  | @@  |  @  |@@@@@| @   |@@@  |@   @|  @@@| @@  |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     | @@@ | @   |  @  |     |     |  @  |   @ |     |@    |     |     |     |     |",
   "|     |   @ |     |     | @   |  @  | @@@ |@@@@@|@@@@@|   @ |  @  |@    |     |     |@@@@@|@@@@@|",
   "| @@@@|@@@  |@ @ @|@@@@@| @   |@@@@@|     |    @|   @ |   @ |   @ |@@@@@|@@@@@| @   |  @  |    @|",
   "|@ @ @|  @  |@ @ @|  @  | @@  |  @  |     | @ @ |  @  |   @ |@   @|@    |    @|@ @  |  @  |    @|",
   "|   @@|@@@@@|@ @ @|  @  | @ @ |  @  |     |  @  | @@@ |   @ |@   @|@    |    @|   @ |@ @ @| @ @ |",
   "|   @ |  @  |   @ |  @  | @   | @   |     | @ @ |@ @ @|  @  |@   @|@    |   @ |    @|@ @ @|  @  |",
   "| @@  | @   |  @  | @   | @   |@    |@@@@@|@    |  @  | @   |@   @| @@@@| @@  |    @|  @  | @ @ |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
   "|     |     |     |     |     |     |     | @@@ |@   @|     |     |     |     |     |  @  |@@@  |",
   "| @@@ |   @ |    @|@@@@@| @   | @@@ |@@@@@|     |@   @|     |@    |@@@@@|@@@@@|@@   |@  @ |@ @  |",
   "|     |  @  |    @| @   | @   |   @ |    @|@@@@@|@   @|  @  |@    |@   @|@   @|     | @   |@@@  |",
   "| @@@ | @   | @ @ |@@@@@|@@@@@|   @ |@@@@@|    @|@   @|@ @  |@   @|@   @|@   @|    @|     |     |",
   "|     | @  @|  @  | @   | @  @|   @ |    @|    @|    @|@ @ @|@  @ |@   @|    @|    @|     |     |",
   "|@@@@ | @@@@| @ @ | @   | @ @ |   @ |    @|   @ |   @ |@ @ @|@ @  |@   @|   @ |   @ |     |     |",
   "|    @|    @|@    |  @@@| @   |@@@@@|@@@@@|  @  |  @  |@ @@ |@@   |@@@@@|  @  |@@@  |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |",
   "+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+",
};

enum
{
   CHAR_ROWS = 11,
   CHAR_COLS = 5,
};

static void lookup(char lines[CHAR_ROWS][CHAR_COLS + 1], int code)
{
   memset(lines, 0, CHAR_ROWS * (CHAR_COLS + 1));

   int hi = code / 16;
   int lo = code % 16;

   switch (hi)
   {
      case 2 ... 7:
      case 0xa ... 0xd:
         break;
      default:
         hi = lo = 0;
   }

   int x = 1 + lo * (CHAR_COLS + 1);
   int y = 1 + hi * (CHAR_ROWS + 1);

   for (int index = 0; index < CHAR_ROWS; ++index)
   {
      memcpy(lines[index], charset[y + index] + x, CHAR_COLS);
   }
}

uint8_t display_content[0x100];
uint32_t cursor_index;
int cursor_state;

static void render(void)
{
   enum
   {
      SCREEN_WIDTH = 0x20,
   };
   char display_buffer[CHAR_ROWS + 1][SCREEN_WIDTH * (CHAR_COLS + 1) + 1] = { };

   int pixel_col = 0;

   for (int index = 0; index < 0x10; ++index)
   {
      char lines[CHAR_ROWS][CHAR_COLS + 1] = { };

      lookup(lines, display_content[index]);

      for (int pixel_row = 0; pixel_row < CHAR_ROWS; ++pixel_row)
      {
         memcpy(display_buffer[pixel_row] + pixel_col, lines[pixel_row], CHAR_COLS);
         display_buffer[pixel_row][pixel_col + CHAR_COLS] = ' ';
      }

      pixel_col += CHAR_COLS + 1;
   }

   if (cursor_state)
   {
      memcpy(display_buffer[CHAR_ROWS - 1] + cursor_index * (CHAR_COLS + 1), "@@@@@", CHAR_COLS);
   }

   for (int row = 0; row < CHAR_ROWS + 1; ++row)
   {
      printf("+%s\n", display_buffer[row]);
   }
   printf("+\n");
}

void instruction_register(uint8_t code)
{
   if (code == 0x01)
   {
      memset(display_content, 0, sizeof display_content);
      cursor_index = 0;
   }
   else if (code == 0x02)
   {
      cursor_index = 0;
   }
   else if (code == 0x04)
   {
      cursor_state = 1;
      cursor_index = 0; /* Weird, this does not match https://datasheet.octopart.com/HD43160AH-Hitachi-datasheet-108301.pdf ... */
   }
   else if (code == 0x05)
   {
      cursor_state = 0;
   }
   else if (code & 0x80)
   {
      cursor_index = code & ~0x80;
   }

   render();
}

void character_register(uint8_t code)
{
   display_content[cursor_index++] = code;
   render();
}

int _main()
{
   char lines[CHAR_ROWS][CHAR_COLS + 1] = { };

   if (0)
   {
      lookup(lines, 0xdf);

      for (int index = 0; index < CHAR_ROWS; ++index)
      {
         printf("|%s|\n", lines[index]);
      }
   }
   else
   {
      instruction_register(0x01);
      instruction_register(0x04);
      character_register('a');
      character_register('b');
      character_register('c');
   }

   return 0;
}
